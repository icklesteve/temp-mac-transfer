name: New PR

permissions:
  pull-requests: read

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]

jobs:
  check-pr:
    runs-on: ubuntu-latest

    env:
      BLOCK_HOURS: '0.25' # e.g. 0.25 for testing

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate gh CLI
        run: |
          gh auth setup-git
          gh auth login --with-token <<< "${GH_TOKEN}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Evaluate PR age
        run: |
          set -euo pipefail
          pr_number="${{ github.event.pull_request.number }}"
          created_at="$(gh pr view "$pr_number" --json createdAt --jq '.createdAt')"
          labels="$(gh pr view "$pr_number" --json labels --jq '.labels[].name' || true)"

          if echo "$labels" | grep -qi "urgent"; then
            echo "::notice::Bypass label detected. Skipping block."
            exit 0
          fi

          now=$(date -u +%s)
          created=$(date -u -d "$created_at" +%s)
          age_hours=$(python3 -c "print(round((${now} - ${created}) / 3600, 2))")

          if (( $(echo "$age_hours < ${BLOCK_HOURS}" | bc -l) )); then
            echo "::error::PR #$pr_number is ${age_hours}h old. Must wait ${BLOCK_HOURS}h."
            exit 1
          else
            echo "::notice::PR #$pr_number is ${age_hours}h old (OK)."
          fi