name: New PR

permissions:
  pull-requests: read

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]

  schedule:
    # - cron: '0 * * * *' # every hour on the hour (UTC)
    cron: '*/5 * * * *' # every 5 minutes (UTC)

jobs:
  check-pr:
    runs-on: ubuntu-latest

    env:
      BLOCK_HOURS: '0.25' # e.g. 0.25 for testing
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Evaluate PR age
        run: |
          set -euo pipefail

          # Determine whether this is running from a PR event or a scheduled run
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "::notice::Running scheduled PR age check (cron)."
            pr_list=$(gh pr list --state open --json number --jq '.[].number')
          else
            pr_list="${{ github.event.pull_request.number }}"
          fi

          for pr_number in $pr_list; do
            created_at="$(gh pr view "$pr_number" --json createdAt --jq '.createdAt')"
            now=$(date -u +%s)
            created=$(date -u -d "$created_at" +%s)
            age_hours=$(python3 -c "print(round((${now} - ${created}) / 3600, 2))")

            echo "::notice::PR #$pr_number was created at $created_at (age: ${age_hours}h)."

            should_block=$(python3 -c "print(float(${age_hours}) < float(${BLOCK_HOURS}))")
            if [ "$should_block" = "True" ]; then
              echo "::error::PR #$pr_number is only ${age_hours}h old. Must wait at least ${BLOCK_HOURS}h before merging."
            else
              echo "::notice::PR #$pr_number is ${age_hours}h old â€” OK to merge."
            fi
          done
